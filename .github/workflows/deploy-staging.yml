name: Deploy to Staging

on:
  push:
    branches: [master]

env:
  PROJECT_ID: bookofmonth
  REGION: europe-west2
  SERVICE_NAME: bookofmonth-api
  REPO_NAME: bookofmonth

jobs:
  deploy-api:
    name: Deploy API to Cloud Run
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for Workload Identity Federation

    outputs:
      service_url: ${{ steps.deploy.outputs.url }}

    steps:
      - uses: actions/checkout@v4

      - id: auth
        name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Build and push Docker image
        run: |
          IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/api
          TAG=${{ github.sha }}
          docker build -t ${IMAGE}:${TAG} -t ${IMAGE}:latest .
          docker push ${IMAGE}:${TAG}
          docker push ${IMAGE}:latest

      - id: deploy
        name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_NAME }}
          region: ${{ env.REGION }}
          image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/api:${{ github.sha }}
          secrets: |
            DATABASE_URL=DATABASE_URL:latest
            DJANGO_SECRET_KEY=DJANGO_SECRET_KEY:latest
            NEWS_API_KEY=NEWS_API_KEY:latest
            GEMINI_API_KEY=GEMINI_API_KEY:latest
            BRAVE_API_KEY=BRAVE_API_KEY:latest
          env_vars: |
            ENVIRONMENT=production
            DJANGO_DEBUG=False
            DJANGO_ALLOWED_HOSTS=.run.app
            CORS_ALLOWED_ORIGINS=https://bookofmonth.web.app
            LOG_LEVEL=INFO

      - name: Update Cloud Run Jobs
        run: |
          IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/api:${{ github.sha }}
          for JOB in process-daily-content send-reading-reminder cleanup-old-sessions generate-monthly-book; do
            gcloud run jobs update ${JOB} --image=${IMAGE} --region=${{ env.REGION }} --quiet
          done

      - name: Health check
        run: |
          URL="${{ steps.deploy.outputs.url }}/api/health/"
          for i in 1 2 3 4 5; do
            if curl -sf "${URL}" > /dev/null 2>&1; then
              echo "Health check passed"
              exit 0
            fi
            echo "Attempt ${i}/5 - waiting 10s..."
            sleep 10
          done
          echo "Health check failed"
          exit 1

  deploy-frontend:
    name: Deploy Frontend to Firebase
    runs-on: ubuntu-latest
    needs: deploy-api

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        env:
          VITE_API_BASE_URL: ${{ needs.deploy-api.outputs.service_url }}/api
        run: npm run build

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          projectId: ${{ env.PROJECT_ID }}
          channelId: live
